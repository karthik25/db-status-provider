<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Db-Status-Provider : A simple extension to keep track of the state of your MVC 3/4 application's database!" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Db-Status-Provider</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/karthik25/db-status-provider">View on GitHub</a>

          <h1 id="project_title">Db-Status-Provider</h1>
          <h2 id="project_tagline">A simple extension to keep track of the state of your MVC 3/4 application's database!</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/karthik25/db-status-provider/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/karthik25/db-status-provider/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h3>
<a name="introduction" class="anchor" href="#introduction"><span class="octicon octicon-link"></span></a>Introduction</h3>

<p>This is a very simple extension that can be used to keep track of the state of your application's database. I use this method for my other 
open source project sBlog.Net!</p>

<h3>
<a name="installation" class="anchor" href="#installation"><span class="octicon octicon-link"></span></a>Installation</h3>

<p>To install DbStatusProvider, run the following command in the Package Manager Console</p>

<div class="highlight"><pre><span class="n">PM</span><span class="p">&gt;</span> <span class="n">Install-Package</span> <span class="n">DbStatusProvider</span>
</pre></div>

<p>Or, see below (Usage).</p>

<h3>
<a name="usage" class="anchor" href="#usage"><span class="octicon octicon-link"></span></a>Usage</h3>

<p>Select the ASP.Net MVC project that should contain the DbStatusProvider nuget package. Right click, select "Manage NuGet Packages...".</p>

<p>Select the "Online" option in the left menu, enter "DbStatusProvider" in the search box.</p>

<p>In the results select "DbStatusProvider", click on "Install". Click on "Close".</p>

<p>The following changes will happen to your project.</p>

<ul>
<li>References to "DbStatusProvider.dll" and "WebActivatorEx.dll"</li>
<li>DbStatusProvider.cs to App_Start folder</li>
<li>_DbStatus.cshtml partial view to Views\Shared folder</li>
<li>The following element to web.config</li>
</ul><div class="highlight"><pre><span class="nt">&lt;dbStatusUpdater</span> <span class="na">contextType=</span><span class="s">""</span> <span class="na">scriptsBase=</span><span class="s">""</span> <span class="na">scriptsPrefix=</span><span class="s">""</span> <span class="nt">/&gt;</span>
</pre></div>

<p>The first step would be to create the data context that could be used to get a list of scripts ran / add a script that was successfully ran.</p>

<div class="highlight"><pre><span class="k">namespace</span> <span class="nn">SampleMvcApp.Contexts</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">SchemaContext</span> <span class="p">:</span> <span class="n">ISchemaContext</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NotImplementedException</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">ISchemaVersion</span><span class="p">&gt;</span> <span class="n">GetScriptsInstalled</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NotImplementedException</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">AddScript</span><span class="p">(</span><span class="n">ISchemaVersion</span> <span class="n">schemaVersion</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NotImplementedException</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Lets now update the web.config file as shown below. I guess it's already evident what the first attribute is for. The 2nd attribute
specifies the base folder for the scripts ("~/Sql") and the 3rd attribute specifies the prefix of the scripts relevant to this application, "sc"
in this case.</p>

<div class="highlight"><pre><span class="nt">&lt;dbStatusUpdater</span> <span class="na">contextType=</span><span class="s">"SampleMvcApp.Contexts.SchemaContext"</span> <span class="na">scriptsBase=</span><span class="s">"~/Sql"</span> <span class="na">scriptsPrefix=</span><span class="s">"sc"</span> <span class="nt">/&gt;</span>
</pre></div>

<p>The next step would be to create the folder that would contain the schema change files. Say "Sql" within the root folder. Start creating the scripts
in the format:</p>

<pre><code>scXXYYZZ[.sql]
</code></pre>

<p>"sc" is the prefix defined in the web.config file. Here XX, YY, ZZ are 2 digit numbers following an order. A valid example would be "sc010001.sql", 
where XX = 01, YY = 00 and ZZ = 01. [.sql] is the extension of the and it could pretty much be anything.</p>

<p>That's it you are all set! When the application starts the extension is going to use the context defined and the folder to "see" if any scripts 
are pending. An application variable is created to hold the results of this operation and it could be used like this.</p>

<div class="highlight"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">HomeController</span> <span class="p">:</span> <span class="n">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Index</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">setupStatus</span> <span class="p">=</span> <span class="n">App_Start</span><span class="p">.</span><span class="n">DbStatusProvider</span><span class="p">.</span><span class="n">GetStatus</span><span class="p">();</span>
        <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">setupStatus</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Now, you could use the partial provided to display the status, as shown below:</p>

<pre><code>@model DbStatusProvider.Objects.SetupStatus

@Html.Partial("_DbStatus", Model)
</code></pre>

<p>That's it! It's "kind of" functional now! But to finalize, you could extend the application further by providing a button, based on the setup status:</p>

<pre><code>@model DbStatusProvider.Objects.SetupStatus

@Html.Partial("_DbStatus", Model)

@using (Html.BeginForm("Submit", "Home"))
{
    &lt;input type="submit" value="Finalize" /&gt;
}
</code></pre>

<p>Then on "submit" you could run the scripts to be run and redirect them to a different page!</p>

<div class="highlight"><pre><span class="na">[HttpPost]</span>
<span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Submit</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">setupStatus</span> <span class="p">=</span> <span class="n">App_Start</span><span class="p">.</span><span class="n">DbStatusProvider</span><span class="p">.</span><span class="n">GetStatus</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">setupStatus</span><span class="p">.</span><span class="n">StatusCode</span> <span class="p">==</span> <span class="n">SetupStatusCode</span><span class="p">.</span><span class="n">HasUpdates</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="kt">var</span> <span class="n">scripts</span> <span class="p">=</span> <span class="n">setupStatus</span><span class="p">.</span><span class="n">FullPathsOfScripts</span><span class="p">;</span>

    <span class="k">foreach</span><span class="p">(</span> <span class="kt">var</span> <span class="n">script</span> <span class="k">in</span> <span class="n">scripts</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Run the scripts</span>

        <span class="c1">// Call the data context's AddScript method to update</span>
    <span class="p">}</span>

    <span class="c1">// Unset the application variable</span>
    <span class="n">App_Start</span><span class="p">.</span><span class="n">DbStatusProvider</span><span class="p">.</span><span class="n">ClearStatus</span><span class="p">();</span>   

    <span class="c1">// You could also reset the status</span>
    <span class="c1">// var newStatus = App_Start.DbStatusProvider.ResetStatus();</span>

    <span class="c1">// Redirect</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nf">View</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Db-Status-Provider maintained by <a href="https://github.com/karthik25">karthik25</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
